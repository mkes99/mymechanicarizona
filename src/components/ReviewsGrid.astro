---
const {
  apiPath = "/api/reviews",
  max = 50,
  initial = 9,
  step = 9,
  writeReviewUrl = "https://search.google.com/local/writereview?placeid=ChIJIRIHWwp01oYRVv-SOeBXy5o",
} = Astro.props;
---

<section class="reviews-grid" data-reviews-grid data-api={apiPath} data-max={max} data-initial={initial} data-step={step} data-write-url={writeReviewUrl}>
  <div class="reviews-grid__header">
    <h2>Customer Reviews</h2>
    <a class="btn btn-border" href={writeReviewUrl} target="_blank" rel="noopener">Write a Review</a>
  </div>

  <div class="reviews-grid__status" data-status style="display:none;"></div>

  <div class="reviews-grid__masonry" data-list>
    <!-- cards injected client-side -->
  </div>

  <div class="reviews-grid__actions">
    <button type="button" class="btn btn-wide btn-border" data-load-more style="display:none;">Load more</button>
  </div>
</section>

<script is:inline>
(() => {
  const root = document.querySelector('[data-reviews-grid]');
  if (!root) return;

  const api = root.getAttribute('data-api') || '/api/reviews';
  const max = Number(root.getAttribute('data-max') || '50');
  const initial = Number(root.getAttribute('data-initial') || '9');
  const step = Number(root.getAttribute('data-step') || '9');

  const status = root.querySelector('[data-status]');
  const list = root.querySelector('[data-list]');
  const btn = root.querySelector('[data-load-more]');

  let all = [];
  let shown = 0;

  function setStatus(type, msg) {
    if (!status) return;
    status.style.display = 'block';
    status.className = `reviews-grid__status reviews-grid__status--${type}`;
    status.textContent = msg;
  }

  function renderStars(n) {
    const s = Math.max(0, Math.min(5, Number(n) || 0));
    return '★★★★★☆☆☆☆☆'.slice(5 - s, 10 - s);
  }

  function renderCard(r) {
    const name = r.reviewer_name || 'Anonymous';
    const text = r.review_text || '';
    const rating = r.rating || 0;

    const div = document.createElement('div');
    div.className = 'review-card';
    div.innerHTML = `
      <div class="review-card__top">
        <div class="review-card__name">${escapeHtml(name)}</div>
        <div class="review-card__stars">${escapeHtml(renderStars(rating))}</div>
      </div>
      <div class="review-card__text">${escapeHtml(text)}</div>
    `;
    return div;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function drawMore(count) {
    if (!list) return;
    const next = all.slice(shown, shown + count);
    next.forEach(r => list.appendChild(renderCard(r)));
    shown += next.length;

    if (btn) btn.style.display = shown < all.length ? 'inline-block' : 'none';
  }

  async function init() {
    try {
      const res = await fetch(api, { headers: { 'Accept': 'application/json' } });
      const data = await res.json();

      const reviews = Array.isArray(data.reviews) ? data.reviews : [];
      all = reviews.slice(0, max);

      if (!all.length) {
        setStatus('empty', 'No reviews to display yet.');
        if (btn) btn.style.display = 'none';
        return;
      }

      if (status) status.style.display = 'none';
      drawMore(initial);

      if (btn) {
        btn.addEventListener('click', () => drawMore(step));
      }
    } catch (e) {
      setStatus('error', 'Reviews are temporarily unavailable.');
      if (btn) btn.style.display = 'none';
    }
  }

  init();
})();
</script>