---
const {
  apiPath = "/api/reviews",
  max = 50,
  limit = 12, // how many to show in the slider
  autoplay = true,
  writeReviewUrl = "https://search.google.com/local/writereview?placeid=ChIJIRIHWwp01oYRVv-SOeBXy5o",
  title = "What customers are saying",
} = Astro.props;
---

<section
  class="reviews-slider"
  data-reviews-slider
  data-api={apiPath}
  data-max={max}
  data-limit={limit}
  data-autoplay={autoplay ? "1" : "0"}
>
  <div class="reviews-slider__header">
    <h2 class="reviews-slider__title">{title}</h2>
    <a class="btn btn-border" href={writeReviewUrl} target="_blank" rel="noopener">
      Write a review
    </a>
  </div>

  <div class="reviews-slider__status" data-status style="display:none;"></div>

  <!-- Slider track (Slick will transform this if available) -->
  <div class="reviews-slider__track" data-track>
    <!-- cards injected client-side -->
  </div>
</section>

<script is:inline>
(() => {
  const root = document.querySelector('[data-reviews-slider]');
  if (!root) return;

  const api = root.getAttribute('data-api') || '/api/reviews';
  const max = Number(root.getAttribute('data-max') || '50');
  const limit = Number(root.getAttribute('data-limit') || '12');
  const autoplay = (root.getAttribute('data-autoplay') || '1') === '1';

  const status = root.querySelector('[data-status]');
  const track = root.querySelector('[data-track]');

  function setStatus(type, msg) {
    if (!status) return;
    status.style.display = 'block';
    status.className = `reviews-slider__status reviews-slider__status--${type}`;
    status.textContent = msg;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function renderStars(n) {
    const s = Math.max(0, Math.min(5, Number(n) || 0));
    return '★★★★★☆☆☆☆☆'.slice(5 - s, 10 - s);
  }

  function cardHtml(r) {
    const name = r.reviewer_name || 'Anonymous';
    const text = r.review_text || '';
    const rating = r.rating || 0;

    return `
      <div class="review-slide">
        <div class="review-card">
          <div class="review-card__top">
            <div class="review-card__name">${escapeHtml(name)}</div>
            <div class="review-card__stars">${escapeHtml(renderStars(rating))}</div>
          </div>
          <div class="review-card__text">${escapeHtml(text)}</div>
        </div>
      </div>
    `;
  }

  async function init() {
    if (!track) return;

    try {
      const res = await fetch(api, { headers: { 'Accept': 'application/json' } });
      const data = await res.json().catch(() => null);

      const reviews = data && Array.isArray(data.reviews) ? data.reviews : [];
      const items = reviews.slice(0, Math.min(max, limit));

      if (!items.length) {
        setStatus('empty', 'No reviews to display yet.');
        return;
      }

      if (status) status.style.display = 'none';
      track.innerHTML = items.map(cardHtml).join('');

      // If Slick is present (theme uses jQuery + slick), initialize it.
      // Otherwise the flex overflow-x fallback stays.
      const hasJQ = typeof window.jQuery === 'function';
      const $ = hasJQ ? window.jQuery : null;

      if ($ && typeof $(track).slick === 'function') {
        // Slick expects direct children as slides; our markup satisfies that.
        $(track).slick({
          slidesToShow: 3,
          slidesToScroll: 1,
          arrows: true,
          dots: false,
          autoplay: autoplay,
          autoplaySpeed: 4000,
          responsive: [
            { breakpoint: 1024, settings: { slidesToShow: 2 } },
            { breakpoint: 768, settings: { slidesToShow: 1 } }
          ]
        });

        // Optional: remove fallback overflow when slick takes over
        track.style.overflow = 'visible';
      }
    } catch (e) {
      setStatus('error', 'Reviews are temporarily unavailable.');
    }
  }

  init();
})();
</script>