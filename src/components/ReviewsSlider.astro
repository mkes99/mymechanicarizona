---
const {
  apiPath = "/api/reviews",
  max = 50,
  limit = 16, // total items rendered; recommend multiples of 4
  autoplay = true,
  autoplayMs = 5500,
  writeReviewUrl = "https://search.google.com/local/writereview?placeid=ChIJIRIHWwp01oYRVv-SOeBXy5o",
  title = "What customers are saying",
} = Astro.props;
---

<section
  class="reviews-slider"
  data-reviews-slider
  data-api={apiPath}
  data-max={max}
  data-limit={limit}
  data-autoplay={autoplay ? "1" : "0"}
  data-autoplay-ms={autoplayMs}
>
  <div class="reviews-slider__header">
    <h2 class="reviews-slider__title">{title}</h2>
    <a class="btn btn-border" href={writeReviewUrl} target="_blank" rel="noopener">Write a review</a>
  </div>

  <div class="reviews-slider__status" data-status style="display:none;"></div>

  <!-- Wrapper lets us place arrows on the sides of the cards -->
  <div class="reviews-slider__frame" data-frame>
    <button
      type="button"
      class="reviews-slider__arrow reviews-slider__arrow--prev"
      data-prev
      aria-label="Previous reviews"
    >
      ‹
    </button>

    <div class="reviews-slider__track" data-track>
      <!-- cards injected client-side -->
    </div>

    <button
      type="button"
      class="reviews-slider__arrow reviews-slider__arrow--next"
      data-next
      aria-label="Next reviews"
    >
      ›
    </button>
  </div>
</section>

<style>
  .reviews-slider { margin-top: 22px; }

  .reviews-slider__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 14px;
    flex-wrap: wrap;
    margin-bottom: 14px;
  }

  .reviews-slider__frame {
    position: relative;
  }

  /* Arrows on the sides of the cards */
  .reviews-slider__arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.70);
    background: #fff;
    box-shadow: 0 12px 26px rgba(0,0,0,.22);
    font-size: 24px;
    line-height: 1;
    font-weight: 900;
    color: rgba(0,0,0,.75);
    cursor: pointer;
    z-index: 3;
  }

  .reviews-slider__arrow--prev { left: -18px; }
  .reviews-slider__arrow--next { right: -18px; }

  @media (max-width: 768px) {
    .reviews-slider__arrow--prev { left: -8px; }
    .reviews-slider__arrow--next { right: -8px; }
  }

  /* Fallback track: snap slider */
  .reviews-slider__track {
    display: flex !important;
    gap: 18px !important;
    overflow-x: auto !important;
    padding-bottom: 8px;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;

    /* give room so arrows don't overlap content */
    padding-left: 26px;
    padding-right: 26px;
  }

  /* IMPORTANT: Hard-lock card width so we never see 9 */
  .reviews-slider__track > .review-card--slider {
    scroll-snap-align: start;

    /* 4-up default */
    flex: 0 0 calc((100% - (18px * 3)) / 4) !important;
    width: calc((100% - (18px * 3)) / 4) !important;
    min-width: calc((100% - (18px * 3)) / 4) !important;
    max-width: calc((100% - (18px * 3)) / 4) !important;
  }

  @media (max-width: 1200px) {
    .reviews-slider__track > .review-card--slider {
      flex-basis: calc((100% - (18px * 2)) / 3) !important;
      width: calc((100% - (18px * 2)) / 3) !important;
      min-width: calc((100% - (18px * 2)) / 3) !important;
      max-width: calc((100% - (18px * 2)) / 3) !important;
    }
  }

  @media (max-width: 992px) {
    .reviews-slider__track > .review-card--slider {
      flex-basis: calc((100% - 18px) / 2) !important;
      width: calc((100% - 18px) / 2) !important;
      min-width: calc((100% - 18px) / 2) !important;
      max-width: calc((100% - 18px) / 2) !important;
    }
  }

  @media (max-width: 768px) {
    .reviews-slider__track > .review-card--slider {
      flex-basis: 100% !important;
      width: 100% !important;
      min-width: 100% !important;
      max-width: 100% !important;
    }
  }

  /* Card (white, sits over hero image) */
  .reviews-slider .review-card--slider {
    background: #fff !important;
    border-radius: 18px;
    padding: 16px 16px 12px;
    border: 1px solid rgba(255,255,255,.70);
    box-shadow: 0 14px 34px rgba(0,0,0,.22);
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .reviews-slider .review-card__meta {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
    margin-bottom: 8px;
  }

  .reviews-slider .review-card__name {
    font-weight: 700;
    color: #1f2937;
    line-height: 1.2;
  }

  .reviews-slider .review-card__time {
    font-size: 13px;
    color: #6b7280;
  }

  .reviews-slider .review-card__stars {
    font-size: 14px;
    letter-spacing: 1px;
    color: #fbbc04;
  }

  .reviews-slider .review-card__text {
    font-size: 14px;
    line-height: 1.55;
    color: #374151;
    margin-top: 6px;
  }

  .reviews-slider .review-card__text--clamp {
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .reviews-slider .review-card__footer {
    margin-top: auto;
    padding-top: 12px;
    border-top: 1px solid rgba(0,0,0,.08);
  }

  .reviews-slider .review-card__google {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    color: #1a73e8;
    text-decoration: none;
    font-weight: 700;
  }

  .reviews-slider .review-card__google:hover { text-decoration: underline; }

  /* Hide fallback arrows if Slick takes over */
  .reviews-slider[data-slick="1"] .reviews-slider__arrow { display: none; }

  /* Slick spacing if active */
  .reviews-slider .slick-list { margin: 0 -10px; }
  .reviews-slider .slick-slide { padding: 0 10px; }

  .reviews-slider__status {
    margin: 12px 0 0;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,.12);
    background: #fff;
    font-weight: 800;
  }
</style>

<script is:inline>
(() => {
  const root = document.querySelector('[data-reviews-slider]');
  if (!root) return;

  const api = root.getAttribute('data-api') || '/api/reviews';
  const max = Number(root.getAttribute('data-max') || '50');
  const limit = Number(root.getAttribute('data-limit') || '16');
  const autoplay = (root.getAttribute('data-autoplay') || '1') === '1';
  const autoplayMs = Number(root.getAttribute('data-autoplay-ms') || '5500');

  const status = root.querySelector('[data-status]');
  const track = root.querySelector('[data-track]');
  const prevBtn = root.querySelector('[data-prev]');
  const nextBtn = root.querySelector('[data-next]');

  function setStatus(type, msg) {
    if (!status) return;
    status.style.display = 'block';
    status.className = `reviews-slider__status reviews-slider__status--${type}`;
    status.textContent = msg;
  }
  function hideStatus() {
    if (!status) return;
    status.style.display = 'none';
    status.textContent = '';
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function renderStars(n) {
    const s = Math.max(0, Math.min(5, Number(n) || 0));
    return '★★★★★☆☆☆☆☆'.slice(5 - s, 10 - s);
  }

  function getGoogleUrl(r) {
    return (
      r.url ||
      r.review_url ||
      r.google_url ||
      r.link ||
      'https://www.google.com/maps?cid=11154105522663391062'
    );
  }

  function cardEl(r) {
    const name = r.reviewer_name || r.author_name || r.name || 'Anonymous';
    const text = r.review_text || r.text || r.content || '';
    const rating = Number(r.rating || r.stars || 0);

    const when =
      r.relative_time_description ||
      r.relative_time ||
      r.timeago ||
      r.time_ago ||
      '';

    const googleUrl = getGoogleUrl(r);

    const div = document.createElement('div');
    div.className = 'review-card review-card--slider';
    div.innerHTML = `
      <div class="review-card__meta">
        <div class="review-card__name">${escapeHtml(name)}</div>
        ${when ? `<div class="review-card__time">${escapeHtml(when)}</div>` : ``}
        <div class="review-card__stars">${escapeHtml(renderStars(rating))}</div>
      </div>

      <div class="review-card__text review-card__text--clamp">
        ${escapeHtml(text)}
      </div>

      <div class="review-card__footer">
        <a class="review-card__google" href="${escapeHtml(googleUrl)}" target="_blank" rel="noopener">
          View on Google
        </a>
      </div>
    `;
    return div;
  }

  function cardsPerView() {
    const w = window.innerWidth || 1200;
    if (w <= 768) return 1;
    if (w <= 992) return 2;
    if (w <= 1200) return 3;
    return 4;
  }

  function scrollByCards(dir) {
    if (!track) return;
    const card = track.querySelector('.review-card--slider');
    if (!card) return;

    const cards = cardsPerView();
    const gap = 18; // must match CSS gap
    const dx = (card.getBoundingClientRect().width + gap) * cards * dir;

    track.scrollBy({ left: dx, behavior: 'smooth' });
  }

  function initFallbackControls() {
    if (prevBtn) prevBtn.addEventListener('click', () => scrollByCards(-1));
    if (nextBtn) nextBtn.addEventListener('click', () => scrollByCards(1));

    if (autoplay) {
      let t = setInterval(() => scrollByCards(1), autoplayMs);
      root.addEventListener('mouseenter', () => { clearInterval(t); });
      root.addEventListener('mouseleave', () => { t = setInterval(() => scrollByCards(1), autoplayMs); });
    }
  }

  async function init() {
    if (!track) return;

    try {
      const res = await fetch(api, { headers: { 'Accept': 'application/json' } });
      const data = await res.json().catch(() => null);

      const reviews = data && Array.isArray(data.reviews) ? data.reviews : [];
      const items = reviews.slice(0, Math.min(max, limit));

      if (!items.length) {
        setStatus('empty', 'No reviews to display yet.');
        return;
      }

      hideStatus();
      track.innerHTML = '';
      items.forEach(r => track.appendChild(cardEl(r)));

      // If Slick exists, use it and hide our arrows
      const hasJQ = typeof window.jQuery === 'function';
      const $ = hasJQ ? window.jQuery : null;

      if ($ && typeof $(track).slick === 'function') {
        if (!$(track).hasClass('slick-initialized')) {
          root.setAttribute('data-slick', '1');
          $(track).slick({
            slidesToShow: 4,
            slidesToScroll: 4,
            arrows: true,
            dots: false,
            autoplay: autoplay,
            autoplaySpeed: autoplayMs,
            responsive: [
              { breakpoint: 1200, settings: { slidesToShow: 3, slidesToScroll: 3 } },
              { breakpoint: 992,  settings: { slidesToShow: 2, slidesToScroll: 2 } },
              { breakpoint: 768,  settings: { slidesToShow: 1, slidesToScroll: 1 } }
            ]
          });
        }
        return;
      }

      initFallbackControls();
    } catch (e) {
      setStatus('error', 'Reviews are temporarily unavailable.');
    }
  }

  init();
})();
</script>