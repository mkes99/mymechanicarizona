---
/**
 * JoinOurTeamForm.astro
 * - POSTs to /api/forms via forms-recaptcha-v3.js.
 * - No native HTML5 constraints to avoid `:invalid` styling on load.
 * - Uses Formidable's `.frm_blank_field` class for the existing error styling.
 * - Implements a lightweight Dropzone-like UX for the single file upload.
 */

const FORM_ID = "form_application";
// Match backend routing expectations (used for email subject / routing).
const FORM_NAME = "Join Our Team";
const MAX_UPLOAD_BYTES = 20 * 1024 * 1024; // 20MB
const ACCEPT = ".pdf,.doc,.docx";
---

<div class="frm_forms with_frm_style frm_center_submit frm_style_formidable-style" id="frm_form_5_container">
  <form
    id={FORM_ID}
    class="frm-show-form mm-form"
    data-mm-form
    data-form-name={FORM_NAME}
    method="post"
    action="/api/forms"
    enctype="multipart/form-data"
    novalidate
  >
    <div class="frm_form_fields">
      <fieldset>
        <legend class="frm_screen_reader">Application</legend>
        <div class="frm_fields_container">

          <div id="frm_field_80_container" class="frm_form_field form-field frm_required_field frm_hidden_container frm_first frm_half">
            <label class="frm_primary_label" for="field_qwwsm">First Name <span class="frm_required">*</span></label>
            <input id="field_qwwsm" name="first_name" placeholder="First Name" type="text" />
          </div>

          <div id="frm_field_81_container" class="frm_form_field form-field frm_required_field frm_hidden_container frm_half">
            <label class="frm_primary_label" for="field_1auqw">Last Name <span class="frm_required">*</span></label>
            <input id="field_1auqw" name="last_name" placeholder="Last Name" type="text" />
          </div>

          <div id="frm_field_82_container" class="frm_form_field form-field frm_required_field frm_hidden_container">
            <label class="frm_primary_label" for="field_wlhyu">Phone Number <span class="frm_required">*</span></label>
            <input id="field_wlhyu" name="phone" placeholder="Phone Number" type="tel" data-validate="phone" />
          </div>

          <div id="frm_field_88_container" class="frm_form_field form-field frm_required_field frm_hidden_container">
            <label class="frm_primary_label" for="field_pqkwz">Email <span class="frm_required">*</span></label>
            <input id="field_pqkwz" name="email" placeholder="Email" type="text" data-validate="email" />
          </div>

          <div id="frm_field_89_container" class="frm_form_field form-field frm_required_field frm_hidden_container frm_full_upload">
            <label class="frm_primary_label" for="field_n3sjm">Attach Resume <span class="frm_required">*</span></label>

            <input
              id="field_n3sjm"
              name="resume"
              type="file"
              accept={ACCEPT}
              data-max-bytes={MAX_UPLOAD_BYTES}
              style="position:absolute;left:-9999px;width:1px;height:1px;"
            />

            <div class="frm_dropzone frm_single_upload dz-clickable" id="file89_dropzone" role="group">
              <div class="dz-message">
                <span class="frm_icon_font frm_upload_icon"></span>
                <span class="frm_upload_text"><button type="button">Drop your resume here or click to upload</button></span>
                <span class="frm_compact_text"><button type="button">Choose File</button></span>
                <div class="frm_small_text">Maximum upload size: 20MB</div>
                <div class="frm_small_text" id="resume_filename" aria-live="polite"></div>
                <div class="frm_small_text">
                  <button type="button" class="btn btn-border btn-invert" id="resume_remove_btn" style="display:none; padding:6px 10px; font-size:12px;">Remove file</button>
                </div>
              </div>
            </div>
          </div>

          <input type="hidden" name="recaptcha_token" value="" />

          <div id="frm_field_107_container">
            <label for="field_3ldam">If you are human, leave this field blank.</label>
            <input class="frm_verify" id="field_3ldam" name="honeypot" type="text" />
          </div>

          <div class="frm_submit">
            <button class="frm_button_submit frm_final_submit btn btn-wide btn-border btn-invert" type="submit">
              <span>Submit Resume</span>
            </button>
          </div>
          <div class="form-status" aria-live="polite" data-form-status style="display:none;"></div>
        </div>
      </fieldset>
    </div>
  </form>
</div>

<script is:inline>
  (() => {
    const form = document.getElementById("form_application");
    if (!form) return;

    const FIELD_WRAP_ID = "frm_field_89_container";

    const dropzone = document.getElementById("file89_dropzone");
    const fileInput = document.getElementById("field_n3sjm");
    const filenameEl = document.getElementById("resume_filename");
    const removeBtn = document.getElementById("resume_remove_btn");
    const statusEl = form.querySelector("[data-form-status]");

    if (!dropzone || !fileInput || !filenameEl) return;

    // Read max size from data attr with fallback
    const maxBytes =
      Number(fileInput.getAttribute("data-max-bytes") || "0") || 20 * 1024 * 1024;

    // Accept list from input (".pdf,.doc,.docx") -> [".pdf", ".doc", ".docx"]
    const acceptList = (fileInput.getAttribute("accept") || "")
      .split(",")
      .map((s) => s.trim().toLowerCase())
      .filter(Boolean);

    // Own the state (Safari-safe). We'll best-effort sync to input.files.
    let selectedFile = null;

    const fieldWrap = document.getElementById(FIELD_WRAP_ID);

    const showUploadError = (msg) => {
      if (!statusEl) return;
      statusEl.style.display = "block";
      statusEl.className = "form-status form-status--error";
      statusEl.textContent = msg;
    };

    const clearStatus = () => {
      if (!statusEl) return;
      statusEl.style.display = "none";
      statusEl.textContent = "";
    };

    const formatBytes = (n) => {
      const b = Number(n || 0);
      if (b < 1024) return `${b} B`;
      const kb = b / 1024;
      if (kb < 1024) return `${kb.toFixed(1)} KB`;
      const mb = kb / 1024;
      return `${mb.toFixed(1)} MB`;
    };

    // ✅ Always store the truth on the input for Safari-safe submit handling
    const syncStore = () => {
      // Global submit handler reads fileInput._mmFile and appends to FormData
      fileInput._mmFile = selectedFile || null;
    };

    // Best-effort: sync our state back into the real <input type="file">
    const syncToInput = () => {
      // Always update Safari-safe store
      syncStore();

      try {
        if (!selectedFile) {
          fileInput.value = "";
          return;
        }
        const dt = new DataTransfer();
        dt.items.add(selectedFile);
        fileInput.files = dt.files;
      } catch (_) {
        // Safari may block programmatic assignment; that's OK.
      }
    };

    const setUI = () => {
      if (!selectedFile) {
        filenameEl.textContent = "";
        if (removeBtn) removeBtn.style.display = "none";
        return;
      }

      filenameEl.textContent = `Selected: ${selectedFile.name} (${formatBytes(selectedFile.size)})`;
      if (removeBtn) removeBtn.style.display = "inline-block";
    };

    const clearFile = () => {
      selectedFile = null;
      try {
        fileInput.value = "";
      } catch (_) {}
      syncToInput(); // ✅ also updates store
      setUI();
    };

    const extOf = (name) => {
      const i = String(name || "").lastIndexOf(".");
      return i >= 0 ? String(name).slice(i).toLowerCase() : "";
    };

    const isAllowedByAccept = (file) => {
      if (!acceptList.length) return true;
      const ext = extOf(file?.name);
      return acceptList.includes(ext);
    };

    const validateFile = (file) => {
      if (!file) return { ok: false, msg: "Please choose a file." };

      if (!isAllowedByAccept(file)) {
        return {
          ok: false,
          msg: `Invalid file type. Please upload one of: ${acceptList.join(", ")}`,
        };
      }

      if (maxBytes && file.size > maxBytes) {
        return {
          ok: false,
          msg: `File is too large. Please keep it under ${Math.round(
            maxBytes / (1024 * 1024),
          )}MB.`,
        };
      }

      return { ok: true, msg: "" };
    };

    const assignFile = (file) => {
      const { ok, msg } = validateFile(file);

      if (!ok) {
        clearFile();
        fieldWrap?.classList.add("frm_blank_field");
        showUploadError(msg);
        return;
      }

      selectedFile = file;
      clearStatus();
      fieldWrap?.classList.remove("frm_blank_field");

      syncToInput(); // ✅ updates store + best-effort input.files
      setUI();
    };

    const openPicker = (e) => {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      fileInput.click();
    };

    // --- Remove button ---
    if (removeBtn) {
      removeBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        clearFile();
        clearStatus();
        fieldWrap?.classList.add("frm_blank_field");
      });
    }

    // --- Click handling ---
    // Only open picker when clicking the dropzone but NOT clicking buttons inside it.
    dropzone.addEventListener("click", (e) => {
      const t = e.target;
      if (t && t.closest && t.closest("#resume_remove_btn")) return;
      if (t && t.closest && t.closest("button")) return;
      openPicker(e);
    });

    // Also wire the existing buttons inside the zone
    dropzone.querySelectorAll("button").forEach((btn) => {
      btn.addEventListener("click", openPicker);
    });

    // --- Input change ---
    fileInput.addEventListener("change", () => {
      const f = fileInput.files?.[0] || null;
      assignFile(f);
    });

    // --- Drag/drop ---
    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
    });

    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      const f = e.dataTransfer?.files?.[0] || null;
      assignFile(f);
    });

    // --- Clear error on re-pick ---
    fileInput.addEventListener("click", () => {
      clearStatus();
    });

    // Clear UI when global form script clears fields
    form.addEventListener("mm:form:cleared", () => {
      clearFile();
      fieldWrap?.classList.add("frm_blank_field");
    });

    // ✅ Initialize store + UI
    syncStore();
    setUI();
  })();
</script>